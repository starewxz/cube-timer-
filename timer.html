<!DOCTYPE html>
<html>
    <head>
        <title>Rubik's Cube Timer</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
    </head>
    <body>
        <style>
            body {
                background-color: black;
                margin: 0;
                padding: 0;
                touch-action: manipulation;
            }

            .result-container {
                color: white;
                text-align: center;
                margin-top: 30px
                font-family: "JetBrains Mono", monospace;
                font-size: 30px;
            }

            .stopwatch {
                color: white;
                text-align: center;
                margin-top: 20px;
                font-family: "JetBrains Mono", monospace;
                font-size: 40px;
            }

            .averages {
                position: fixed;
                bottom: 10px;
                left: 10px;
                color: white;
                font-family: "JetBrains Mono", monospace;
                font-size: 15px;
            }

            .result-count {
                position: fixed;
                top: 10px;
                right: 10px;
                color: white;
                font-family: "JetBrains Mono", monospace;
                font-size: 20px;
            }
        </style>

        <!-- Previous result and time difference display -->
        <div id="resultContainer" class="result-container">
            <div id="previousResult"></div>
            <div id="lastResult"></div>
        </div>

        <!-- Stopwatch display -->
        <div id="stopwatch" class="stopwatch">00:00:00</div>

        <!-- Averages and best result display -->
        <div id="averages" class="averages">
            Avg 5: --:--:-- | Best 5: --:--:-- | Avg 12: --:--:-- | Best 12: --:--:-- | Best All Time: --:--:--
        </div>

        <!-- Total count of all results -->
        <div id="resultCount" class="result-count">
            Results: 0
        </div>

        <script>
            let isRunning = false;
            let timerInterval;
            let elapsedTime = 0;
            let isHoldingSpace = false;
            let readyToStart = false;
            let holdStartTime = 0;

            // Results storage
            const results = JSON.parse(localStorage.getItem('results')) || [];

            // Best results storage
            const bestResults = {
                5: localStorage.getItem('best5') ? parseInt(localStorage.getItem('best5')) : Infinity,
                12: localStorage.getItem('best12') ? parseInt(localStorage.getItem('best12')) : Infinity,
                allTime: localStorage.getItem('bestAllTime') ? parseInt(localStorage.getItem('bestAllTime')) : Infinity
            };

            // Format time to display it as mm:ss:ms
            function formatTime(ms) {
                const minutes = String(Math.floor((ms / 60000) % 60)).padStart(2, '0');
                const seconds = String(Math.floor((ms / 1000) % 60)).padStart(2, '0');
                const milliseconds = String(Math.floor((ms / 10) % 100)).padStart(2, '0');
                return `${minutes}:${seconds}:${milliseconds}`;
            }

            // Update the stopwatch display
            function updateDisplay() {
                document.getElementById('stopwatch').textContent = formatTime(elapsedTime);
            }

            // Calculate average of last 'count' results
            function calculateAverage(count) {
                if (results.length < count) return null;
                const sum = results.slice(-count).reduce((acc, curr) => acc + curr, 0);
                return sum / count;
            }

            // Update average and best results display
            function updateResults() {
                const avg5 = calculateAverage(5);
                const avg12 = calculateAverage(12);

                // Calculate best results
                const best5 = Math.min(...results.slice(-5), bestResults[5]);
                const best12 = Math.min(...results.slice(-12), bestResults[12]);
                const bestAllTime = Math.min(...results, bestResults.allTime);

                // Update best results in local storage
                if (best5 < bestResults[5]) {
                    localStorage.setItem('best5', best5);
                    bestResults[5] = best5;
                }
                if (best12 < bestResults[12]) {
                    localStorage.setItem('best12', best12);
                    bestResults[12] = best12;
                }
                if (bestAllTime < bestResults.allTime) {
                    localStorage.setItem('bestAllTime', bestAllTime);
                    bestResults.allTime = bestAllTime;
                }

                document.getElementById('averages').textContent = 
                    `Avg 5: ${avg5 ? formatTime(avg5) : '--:--:--'} | Best 5: ${formatTime(bestResults[5])} | ` +
                    `Avg 12: ${avg12 ? formatTime(avg12) : '--:--:--'} | Best 12: ${formatTime(bestResults[12])} | ` +
                    `Best All Time: ${formatTime(bestResults.allTime)}`;
            }

            // Start the timer
            function startTimer() {
                const startTime = Date.now() - elapsedTime;
                timerInterval = setInterval(() => {
                    elapsedTime = Date.now() - startTime;
                    updateDisplay();
                }, 10);
            }

            // Stop the timer
            function stopTimer() {
                clearInterval(timerInterval);
            }

            // Reset the timer
            function resetTimer() {
                elapsedTime = 0;
                updateDisplay();
            }

            // Save the current result and calculate time difference with the previous result
            function saveLastResult() {
                const lastResult = elapsedTime;
                const previousResult = localStorage.getItem('previousResult') ? parseInt(localStorage.getItem('previousResult')) : null;

                if (previousResult !== null) {
                    const timeDifference = lastResult - previousResult;
                    const differenceText = `Difference: ${formatTime(Math.abs(timeDifference))} ${timeDifference > 0 ? '+' : timeDifference < 0 ? '-' : ''}`;
                    document.getElementById('lastResult').textContent = `Last Result: ${formatTime(lastResult)} | ${differenceText}`;
                } else {
                    document.getElementById('lastResult').textContent = `Last Result: ${formatTime(lastResult)}`;
                }

                document.getElementById('previousResult').textContent = `Previous Result: ${previousResult ? formatTime(previousResult) : 'None'}`;
                localStorage.setItem('previousResult', lastResult);

                // Add the result to the array and update averages and best results
                results.push(lastResult);
                localStorage.setItem('results', JSON.stringify(results));
                updateResults();

                // Update the total count display
                document.getElementById('resultCount').textContent = `Results: ${results.length}`;
            }

            // Handle spacebar or touch interactions
            function handleInteraction() {
                if (readyToStart) {
                    if (!isRunning) {
                        // If the timer was stopped, reset it before starting a new round
                        resetTimer();
                        document.getElementById('stopwatch').style.color = 'white';
                        startTimer();
                        isRunning = true;
                    } else {
                        // Stop the timer if it's already running
                        stopTimer();
                        isRunning = false;
                        saveLastResult(); // Save the result and calculate the difference
                    }
                } else if (isRunning) {
                    // Stop the timer if running
                    stopTimer();
                    isRunning = false;
                    saveLastResult(); // Save the result and calculate the difference
                }

                // Reset the state
                readyToStart = false;
            }

            // Handle keydown and keyup events for desktop
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && !isHoldingSpace) {
                    isHoldingSpace = true;
                    holdStartTime = Date.now();
                    document.getElementById('stopwatch').style.color = 'red';

                    setTimeout(() => {
                        if (isHoldingSpace) {
                            document.getElementById('stopwatch').style.color = 'green';
                            readyToStart = true;
                        }
                    }, 500); // Change to green after 0.5 seconds if still holding
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.code === 'Space') {
                    if (isHoldingSpace) {
                        isHoldingSpace = false;
                        handleInteraction();
                    }
                }
            });

            // Handle touch events for mobile
            document.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent default touch actions
                if (!isHoldingSpace) {
                    isHoldingSpace = true;
                    holdStartTime = Date.now();
                    document.getElementById('stopwatch').style.color = 'red';

                    setTimeout(() => {
                        if (isHoldingSpace) {
                            document.getElementById('stopwatch').style.color = 'green';
                            readyToStart = true;
                        }
                    }, 500); // Change to green after 0.5 seconds if still holding
                }
            });

            document.addEventListener('touchend', (e) => {
                if (isHoldingSpace) {
                    isHoldingSpace = false;
                    handleInteraction();
                }
            });

            // Initialize the count display
            document.getElementById('resultCount').textContent = `Results: ${results.length}`;
        </script>
    </body>
</html>
